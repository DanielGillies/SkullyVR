<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>SKULLY VR Experience</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/vr.css">
</head>

<body>
    <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.1.0/annyang.min.js"></script>
    <script src="js/three.min.js"></script>
    <script src="js/DeviceOrientationController.js"></script>
    <script src="js/StereoEffect.js"></script>
    <video id="video" loop style="display:none">
        <source src="flying.mp4" type="video/mp4">
    </video>
    <canvas id="copy"></canvas>
    <script>
    var camera, camera2, scene, renderer, renderer2, effect;
    var geometry, material, mesh, texture, skybox;
    var controls, controls2;
    var canv, destCanv, ctx;

    var loader = new THREE.TextureLoader();

    var inited = false;

    var controlsEnabled = true;

    if (annyang) {
        var commands = {
            "start video" : function() {
                inited = true;
                init();
                animate();
            },
            "say *tag" : clog
        };

        var clog = function(tag) {
            console.log("YOU SAID: " + tag);
        }

        annyang.addCommands(commands);

        annyang.start();
    }

    document.addEventListener("touchstart", function() {
        if (!inited) {
            inited = true;
            console.log("TOUCHED")
            init();
            animate();
        }
    })

    document.addEventListener("click", function() {
        if (!inited) {
            inited = true;
            console.log("CLICKED")
            init();
            animate();
        }
    }, false)

    function init() {

        console.log("FFFFFFF");

        camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
        camera2 = new THREE.PerspectiveCamera(120, window.innerWidth / window.innerHeight, 1, 1000);

        scene = new THREE.Scene();

        renderer = new THREE.WebGLRenderer();
        // renderer.setClearColor(0xffffff);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        renderer2 = new THREE.WebGLRenderer();
        // renderer2.setClearColor(0xffffff);
        renderer2.setPixelRatio(window.devicePixelRatio);
        renderer2.setSize(120, 70);
        document.body.appendChild(renderer2.domElement);


        var canvases = document.getElementsByTagName("canvas");

        for (var j = 0; j < canvases.length; j++) {
            if (canvases[j].id === "")
                canvases[j].setAttribute("id", "canvas" + (j - 1));
        }

        fullscreen();

        controls = new DeviceOrientationController(camera, renderer.domElement);
        controls2 = new DeviceOrientationController(camera2, renderer2.domElement);
        controls.connect();
        controls2.connect();

        effect = new THREE.StereoEffect(renderer);
        effect.setSize(window.innerWidth, window.innerHeight);

        geometry = new THREE.SphereGeometry(100, 60, 40);

        var video = document.getElementById("video")
        video.play();
        var texture = new THREE.VideoTexture(video);
        texture.minFilter = THREE.NearestFilter;

        material = new THREE.MeshBasicMaterial({
            map: texture
        });


        skyBox = new THREE.Mesh(geometry, material);
        skyBox.scale.set(-1, 1, 1);
        scene.add(skyBox);

        canv = document.getElementById("canvas1");
        destCanv = document.getElementById("copy");

        destCanv.width = canv.width;
        destCanv.height = canv.height;

        destCanv.style.cssText = canv.style.cssText;

        ctx = destCanv.getContext("2d");
        // ctx.drawImage(canv, 0, 0);

        window.addEventListener('resize', onWindowResize, false);

    }

    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        camera2.updateProjectionMatrix();

        // renderer.setSize(window.innerWidth, window.innerHeight);
        // renderer2.setSize(120, 70);

        effect.setSize(window.innerWidth, window.innerHeight);

    }

    function animate() {

        controls.update();
        controls2.updateReverse();

        requestAnimationFrame(animate);

        effect.render(scene, camera);

        // renderer.render(scene, camera);
        renderer2.render(scene, camera2);
        ctx.drawImage(canv, 0, 0);
    }

    function fullscreen() {
        container = document.body;
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        } else if (container.mozRequestFullScreen) {
            container.mozRequestFullScreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        }
    }
    </script>
</body>

</html>
